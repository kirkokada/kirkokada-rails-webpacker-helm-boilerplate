#! /bin/bash
USERNAME=''
PASSWORD=''

while getopts 'u:p:' opt; do
  case "${opt}" in
    u) USERNAME="${OPTARG}";;
    p) PASSWORD="${OPTARG}";;
    \? ) echo "Usage: cmd [-u] [-p]"
  esac
done

docker run -it --rm \
  -e "DOCKER_USERNAME=${USERNAME}" \
  -e "DOCKER_PASSWORD=${PASSWORD}"  \
  -e "DOCKER_REGISTRY=https://index.docker.io/v1/" \
  -v "$(pwd):/opt/data/"  \
  -v "/var/run/docker.sock:/var/run/docker.sock" \
  codeship/dockercfg-generator /opt/data/dockercfg

mkdir ./ci/

echo "Encrypting docker config file..."
jet encrypt dockercfg ci/dockercfg.encrypted

echo "Cleaning up..."
rm -f dockercfg

echo "Done."
